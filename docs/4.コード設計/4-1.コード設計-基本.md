# コード設計 - 基本

## アーキテクチャ概要

本アプリケーションは **React 19 + TypeScript + Vite** をベースとした、モダンな SPA（Single Page Application）として設計されている。

コードの領域を **6 つの主要領域** に分けて、責務の明確化と保守性の向上を図っている。

## 領域分割

### 1. App 系 (`/app`)

- **目的**: 認証済みユーザー向けのメインアプリケーション
- **実装状況**: 🚧 基本機能実装済み
- **特徴**:
  - ロール別ホーム画面（リーダー/見学者）
  - スカウト検索・管理・詳細編集機能
  - リアルタイムデータ同期
- **主要コンポーネント**:
  - `app.tsx`: メインルーティング
  - `home/`: ロール別ダッシュボード
  - `scouts/`: スカウト管理機能
  - `scoutDetail/`: 個人詳細管理

### 2. Auth 系 (`/auth`)

- **目的**: Firebase Authentication による認証機能
- **実装状況**: ✅ 完全実装済み
- **機能**:
  - ログイン・新規登録・パスワードリセット・メール認証
  - AuthContext による認証状態の提供
  - 統一された UI デザイン（背景画像 + ブラーエフェクト）
- **セキュリティ機能**:
  - メールアドレス認証必須
  - 自動リダイレクト機能

### 3. Firebase 系 (`/firebase`)

- **目的**: Firebase 関連機能の統一管理
- **実装状況**: ✅ 基本機能完成
- **機能**:
  - Firebase 初期化と設定
  - 認証コンテキスト管理
  - Firestore データ操作
  - ユーザー・スカウト・グループデータ管理
- **セキュリティ**:
  - 厳密な型定義
  - エラーハンドリング

### 4. Style 系 (`/style`)

- **目的**: UI コンポーネントとデザインシステム
- **実装状況**: ✅ 基本コンポーネント実装済み
- **特徴**:
  - Bootstrap ベースのカスタムコンポーネント
  - レスポンシブデザイン対応
  - 再利用可能なスタイルコンポーネント
- **主要コンポーネント**:
  - `cardDesign.tsx`: ブラーカード
  - `loadingSplash.tsx`: ローディング画面
  - `fullscreanPopup.tsx`: モーダル表示

### 5. Tools 系 (`/tools`)

- **目的**: ユーティリティ関数とヘルパー機能
- **実装状況**: ✅ 基本機能実装済み
- **機能**:
  - データ処理・比較機能
  - ローカルキャッシュ管理
  - 日付操作
  - ランダム値生成
- **パフォーマンス最適化**:
  - 検索クエリキャッシュ
  - スカウトデータキャッシュ

### 6. Types 系 (`/types`)

- **目的**: TypeScript 型定義の集約
- **実装状況**: ✅ 完全実装済み
- **特徴**:
  - ドメインモデルの型安全性確保
  - Firebase Firestore との型連携
  - コンポーネント間の型安全なデータ受け渡し
- **分類**:
  - `user/`: ユーザー関連型
  - `scout/`: スカウト関連型
  - `group/`: グループ関連型
  - `master/`: マスターデータ型

### 7. SysManager 系 (`/sysManager`)

- **目的**: システム管理者専用機能
- **実装状況**: ✅ 基本実装
- **アクセス制御**: 特定ユーザーのみアクセス可能

## 設計方針

### 1. 型安全性重視

- **厳密な TypeScript 設定**: strict モード有効
- **網羅的な型定義**: 全データ構造を型定義
- **実行時型チェック**: Firebase データの型検証
- **コンパイル時エラー防止**: 開発時のバグ早期発見

### 2. コンポーネント指向設計

- **単一責任の原則**: 各コンポーネントは 1 つの責務のみ
- **再利用性**: 共通コンポーネントの積極活用
- **Props による設定**: カスタマイズ可能な設計
- **Composition パターン**: 複雑な UI の効率的な構築

### 3. パフォーマンス最適化

- **遅延読み込み**: `React.lazy()` と `Suspense` 活用
- **メモ化**: 適切な `useMemo` と `useCallback` 使用
- **コード分割**: Vite による自動チャンク分割
- **キャッシュ戦略**: ローカルストレージでの検索結果保存

### 4. 関数型プログラミング指向

- **Pure Component 重視**: 副作用のない関数コンポーネント
- **不変性**: 状態の変更は常に新しいオブジェクト作成
- **高階関数**: 汎用的な処理の抽象化
- **関数合成**: 小さな関数の組み合わせによる複雑な処理

## 実装パターン

### ファイル命名規則

```
/src
├── types/           # 型定義ファイル (camelCase.ts)
├── firebase/        # Firebase 関連 (camelCase.ts)
├── style/          # スタイルコンポーネント (camelCase.tsx)
├── tools/          # ユーティリティ (camelCase.ts)
├── app/            # アプリコンポーネント (camelCase.tsx)
├── auth/           # 認証コンポーネント (camelCase.tsx)
└── sysManager/     # システム管理 (camelCase.tsx)
```

### インポート順序

```typescript
// 1. React 関連
import { FC, useState, useEffect } from "react";
import { useNavigate } from "react-router";

// 2. 外部ライブラリ
import { Button, Card } from "react-bootstrap";
import { FontAwesomeIcon } from "@fortawesome/react-fontawesome";

// 3. 内部コンポーネント・Firebase
import { useAuthContext } from "@/firebase/authContext";
import LoadingSplash from "@/style/loadingSplash";

// 4. 型定義
import User from "@/types/user/user";
import { Scout } from "@/types/scout/scout";

// 5. ユーティリティ・ツール
import getRandomStr from "@/tools/getRandomStr";
```

### エラーハンドリング

```typescript
// 統一されたエラーハンドリング
import { raiseError } from "@/errorHandler";

try {
  const result = await riskyOperation();
  return result;
} catch (error) {
  raiseError("操作に失敗しました", error, { userId, context });
  return null;
}
```

## 初期化とセットアップ

### エントリーポイント構成

```typescript
// main.tsx
createRoot(document.getElementById("root")!).render(
  <StrictMode>
    <BrowserRouter>
      <MainApp />
    </BrowserRouter>
  </StrictMode>
);

// App.tsx - ルート分割
<ErrorProvider>
  <Suspense fallback={<LoadingSplash />}>
    <PopupProvider>
      <AuthProvider>
        <Routes>
          <Route path="/auth/*" element={<Auth />} />
          <Route path="/app/*" element={<AppPage />} />
          <Route path="/sysmanager/*" element={<SysManager />} />
        </Routes>
      </AuthProvider>
    </PopupProvider>
  </Suspense>
</ErrorProvider>;
```

### Firebase 初期化

```typescript
// firebase.ts
const firebaseConfig = {
  // 本番環境設定
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const auth = getAuth(app);
const db = getFirestore(app);

export { app, analytics, auth, db };
```

### 開発環境設定

- **Vite 設定**: 高速ビルド、HMR、パスエイリアス
- **TypeScript 設定**: 厳格モード、ESNext ターゲット
- **ESLint 設定**: React Hook Rules、TypeScript Rules

## セキュリティ考慮

### クライアントサイドセキュリティ

- **XSS 対策**: React の自動エスケープ機能活用
- **認証状態管理**: AuthContext による一元管理
- **ルート保護**: 認証必須ページの自動リダイレクト
- **権限制御**: ロール別 UI 表示制御

### データセキュリティ

- **型安全性**: 不正なデータ構造の防止
- **入力検証**: フォーム入力の事前検証
- **エラー情報制御**: 機密情報を含まないエラーメッセージ

### Firebase セキュリティ

- **API キー管理**: 環境変数での管理推奨
- **Firestore Rules**: サーバーサイドでの厳密なアクセス制御
- **認証必須**: メール認証済みユーザーのみ操作許可

## パフォーマンス戦略

### バンドル最適化

```typescript
// vite.config.ts - マニュアルチャンク分割
rollupOptions: {
  output: {
    manualChunks: {
      react: ["react", "react-dom"],
      "react-router": ["react-router"],
      firebase: ["firebase/app", "firebase/auth", "firebase/firestore"],
    },
  },
},
```

### レンダリング最適化

- **React 19 機能**: 新しい Hooks と最適化機能活用
- **メモ化戦略**: 重い計算処理の適切なキャッシュ
- **仮想化**: 大量データの効率的な表示

### ネットワーク最適化

- **Firebase キャッシュ**: オフライン対応と高速化
- **画像最適化**: WebP 形式での配信
- **静的アセット**: CDN 経由での配信
