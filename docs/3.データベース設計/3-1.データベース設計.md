# データベース設計 概要

## 基本指針

このシステムでは **Firestore** をメインデータベースとして使用する。

データは用途別に **3 つのコレクション** に分散して管理し、権限制御とパフォーマンスの最適化を図っている。

## コレクション構成

### 1. users コレクション

- **目的**: ユーザー個人の基本情報管理
- **特徴**: Firebase Auth の UID と 1 対 1 対応
- **詳細**: [3-2.users コレクション.md](./3-2.usersコレクション.md) を参照

### 2. scouts コレクション

- **目的**: スカウト（子ども）の活動記録・進捗管理
- **特徴**: 複数ユーザーからの閲覧・編集権限制御
- **詳細**: [3-3.scouts コレクション.md](./3-3.scoutsコレクション.md) を参照

### 3. groups コレクション

- **目的**: スカウト団・隊などの組織情報管理
- **特徴**: 管理者権限による階層的アクセス制御
- **詳細**: [3-4.groups コレクション.md](./3-4.groupsコレクション.md) を参照

## 権限設計の基本思想

- **最小権限原則**: 必要最小限の権限のみを付与
- **役割ベースアクセス制御**: VIEW、EDIT、ADMIN の 3 段階で制御
- **メール認証必須**: 認証済みメールアドレスでのみアクセス許可
- **組織階層対応**: 団・隊レベルでの権限継承をサポート

## データアクセス条件

### 1. users コレクション

**読み書き可能条件**:

- ドキュメント ID（UID）と `auth.uid` が一致する場合のみ全操作可能

### 2. scouts コレクション

**読み書き可能条件**:

- **AllowedList 方式**: 対象スカウトの `authed_user` 配列に `auth.email` と一致するメールアドレスが含まれている
- **組織権限方式**: スカウトが所属する団体の `members` サブコレクションで、メールアドレスをキーとするレコードに設定された `role` に応じた操作が可能

### 3. groups コレクション

**読み書き可能条件**:

- _(後で詳細を定義予定)_

## セキュリティ要件

- Firebase Authentication との連携によるユーザー認証
- Firestore Security Rules による DB レベルでの権限制御
- クライアントサイドでの追加検証と UI 制御
