# データベース設計 概要

## 基本指針

このシステムでは **Firestore** をメインデータベースとして使用し、NoSQL の特性を活かしたドキュメント指向設計を採用している。

データは用途別に **3 つのコレクション** に分散して管理し、権限制御とパフォーマンスの最適化を図っている。

## コレクション構成

### 1. users コレクション

- **目的**: ユーザー個人の基本情報管理
- **特徴**: Firebase Auth の UID と 1 対 1 対応
- **実装状況**: ✅ 完全実装済み
- **詳細**: [3-2.users コレクション.md](./3-2.usersコレクション.md) を参照

### 2. scouts コレクション

- **目的**: スカウト（子ども）の活動記録・進捗管理
- **特徴**: 複数ユーザーからの閲覧・編集権限制御、詳細なプロフィール・技能章・イベント管理
- **実装状況**: 🚧 基本機能実装済み（検索・詳細・編集）
- **詳細**: [3-3.scouts コレクション.md](./3-3.scoutsコレクション.md) を参照

### 3. groups コレクション

- **目的**: スカウト団・隊などの組織情報管理
- **特徴**: 管理者権限による階層的アクセス制御、メンバー管理サブコレクション
- **実装状況**: ✅ 基本実装済み
- **詳細**: [3-4.groups コレクション.md](./3-4.groupsコレクション.md) を参照

### 4. admins コレクション

- **目的**: アプリケーション全体の管理者管理
- **特徴**: システム管理者のみアクセス可能
- **実装状況**: ✅ 実装済み

## 権限設計の基本思想

### 権限レベル

- **view**: 閲覧のみ可能
- **edit**: 閲覧・編集が可能
- **admin**: 全権限（作成・編集・削除・メンバー管理）

### アクセス制御原則

- **最小権限原則**: 必要最小限の権限のみを付与
- **役割ベースアクセス制御**: view、edit、admin の 3 段階で制御
- **メール認証必須**: 認証済みメールアドレスでのみアクセス許可
- **組織階層対応**: 団・隊レベルでの権限継承をサポート

## データアクセス条件

### 1. users コレクション

**読み書き可能条件**:

```javascript
// ドキュメント ID（UID）と auth.uid が一致する場合のみ全操作可能
allow read, write: if isOwner(userId);
```

### 2. scouts コレクション

**アクセス条件**:

```javascript
// 読み取り：スカウトが所属するグループのメンバーである場合
allow read: if isAuthenticated() && isGroupMember(resource.data.personal.belongs);

// 編集・削除：スカウトが所属するグループで edit または admin 権限を持つ場合
allow update, delete: if isAuthenticated() && isEditor(resource.data.personal.belongs);

// 作成：対象グループで edit または admin 権限を持つ場合
allow create: if isAuthenticated() && isEditor(request.resource.data.personal.belongs);
```

### 3. groups コレクション

**アクセス条件**:

```javascript
// 読み取り：グループのメンバーである場合
allow read: if isAuthenticated() && isGroupMember(groupId);

// 更新：グループの admin 権限を持つ場合
allow update: if isAuthenticated() && getGroupRole(groupId) == 'admin';

// 作成・削除：アプリ管理者のみ
allow create, delete: if isAppAdmin();
```

#### members サブコレクション

```javascript
// 自分の情報の読み取り：自分のメールアドレスと一致する場合
allow read: if isAuthenticated() && getUserEmail() == memberId;

// メンバー管理：グループの admin 権限を持つ場合
allow write: if isAuthenticated() && getGroupRole(groupId) == 'admin';
```

### 4. admins コレクション

**アクセス条件**:

```javascript
// アプリ管理者のみ全操作可能
allow read, write: if isAppAdmin();
```

## セキュリティ実装

### Firebase Security Rules

- **認証必須**: 全操作でメール認証済みユーザーのみアクセス許可
- **関数ベース制御**: 再利用可能なヘルパー関数による権限チェック
- **サブコレクション対応**: ネストしたデータ構造にも適切な権限設定

### 主要なヘルパー関数

```javascript
// 認証確認
function isAuthenticated()

// 所有者確認
function isOwner(uid)

// グループメンバー確認
function isGroupMember(groupId)

// グループでの権限レベル取得
function getGroupRole(groupId)

// 編集権限確認
function isEditor(groupId)

// アプリ管理者確認
function isAppAdmin()
```

### クライアントサイド検証

- **React コンテキスト**: `AuthContext` による認証状態管理
- **権限別 UI**: ロールに応じた機能の表示・非表示制御
- **リアルタイム同期**: Firestore のリアルタイム機能を活用

## パフォーマンス最適化

### インデックス設計

- **検索クエリ最適化**: `firestore.indexes.json` でカスタムインデックス定義
- **複合クエリ対応**: 複数フィールドでの検索・ソート機能

### データ構造最適化

- **非正規化**: 読み取り性能を重視した適度な非正規化
- **サブコレクション活用**: 大量データの効率的な管理
- **型安全性**: TypeScript による厳密な型定義

## 実装済み機能

### データ操作

- ✅ **ユーザー認証・登録**: Firebase Auth 連携
- ✅ **スカウト管理**: CRUD 操作、検索機能
- ✅ **グループ管理**: 基本的な組織管理
- 🚧 **権限管理**: 基本的なロールベースアクセス制御

### セキュリティ

- ✅ **認証必須制御**: メール認証済みユーザーのみアクセス
- ✅ **ドキュメントレベル権限**: Firestore Rules による細かい制御
- ✅ **型安全性**: TypeScript による静的型チェック

## 今後の拡張予定

### 短期実装予定

- グループ管理機能の完全実装
- より詳細な権限管理機能
- データ分析・レポート機能

### 中長期実装予定

- 階層的組織管理（地区・県連盟レベル）
- データバックアップ・復元機能
- 外部システム連携 API
